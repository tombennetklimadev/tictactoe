<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sync BTC Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #0f172a;
            --text-sub: #64748b; --btc-orange: #F7931A; --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--bg-body); font-family: 'Inter', sans-serif;
            height: 100vh; display: flex; justify-content: center; align-items: center;
        }
        .widget-card {
            background: var(--bg-card); width: 95%; max-width: 1000px;
            padding: 32px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        #price-display { font-size: 42px; font-weight: 700; color: var(--btc-orange); font-feature-settings: "tnum"; }
        .chart-container { position: relative; height: 400px; width: 100%; }
    </style>
</head>
<body>

    <div class="widget-card">
        <div class="header">
            <div>
                <h1 style="font-size: 20px;">Bitcoin Live</h1>
                <p style="color: var(--text-sub); font-size: 14px;">Global Time-Synced Feed (90s)</p>
            </div>
            <div style="text-align: right;">
                <div id="price-display">Syncing...</div>
                <p style="color: var(--text-sub); font-size: 12px; font-weight: 600;">BTC / USD</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="syncChart"></canvas>
        </div>
    </div>

    <script>
        const HISTORY_SECONDS = 90;
        const CHART_RES = 1000; // 1 Punkt pro Sekunde für die Historie
        let chart;
        let targetPrice = 0;
        let currentVisualPrice = 0;

        // 1. Chart Initialisierung
        const ctx = document.getElementById('syncChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(247, 147, 26, 0.15)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

        function initChart() {
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        data: [],
                        borderColor: '#F7931A',
                        borderWidth: 2.5,
                        backgroundColor: gradient,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.4,
                        cubicInterpolationMode: 'monotone'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            position: 'right',
                            grid: { color: '#f1f5f9', borderDash: [5, 5] },
                            ticks: { color: '#94a3b8', font: { size: 11 } }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 2. Globaler Sync: Historie von Binance laden
        async function syncGlobalMarket() {
            try {
                // Wir laden die 1-Minuten-Klines (Kerzen)
                const res = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=2');
                const klines = await res.json();
                
                const openPrice = parseFloat(klines[1][1]);
                const closePrice = parseFloat(klines[1][4]);
                const startTime = klines[1][0];
                
                targetPrice = closePrice;
                currentVisualPrice = closePrice;

                // Wir füllen die letzten 90 Sekunden basierend auf der aktuellen Zeit
                const now = Date.now();
                const historyData = [];
                for (let i = HISTORY_SECONDS; i >= 0; i--) {
                    const ts = now - (i * 1000);
                    // Wir füllen die Historie mit dem Durchschnittspreis (da wir keine Ticks für 90s rückwirkend haben ohne API Key)
                    historyData.push({ x: ts, y: closePrice });
                }
                
                chart.data.datasets[0].data = historyData;
                chart.update();
            } catch (e) { console.error("Sync Error", e); }
        }

        // 3. Live Preis Update
        async function fetchLive() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                const data = await res.json();
                targetPrice = parseFloat(data.price);
            } catch (e) {}
            setTimeout(fetchLive, 2000);
        }

        // 4. Smooth Animation Loop
        function animate() {
            if (currentVisualPrice === 0) { requestAnimationFrame(animate); return; }

            // Smooth Interpolation
            currentVisualPrice += (targetPrice - currentVisualPrice) * 0.05;
            
            const now = Date.now();
            const newDataPoint = { x: now, y: currentVisualPrice };

            // Datenpunkt hinzufügen
            chart.data.datasets[0].data.push(newDataPoint);

            // Fenster auf 90 Sekunden halten
            const cutoff = now - (HISTORY_SECONDS * 1000);
            while (chart.data.datasets[0].data.length > 0 && chart.data.datasets[0].data[0].x < cutoff) {
                chart.data.datasets[0].data.shift();
            }

            // Achsen-Verschiebung
            chart.options.scales.x.min = cutoff;
            chart.options.scales.x.max = now;

            document.getElementById('price-display').innerText = '$ ' + currentVisualPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            chart.update('none');
            requestAnimationFrame(animate);
        }

        // Start
        initChart();
        syncGlobalMarket().then(() => {
            fetchLive();
            animate();
        });
    </script>
</body>
</html>
